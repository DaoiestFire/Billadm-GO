<template>
  <a-layout style="height: 100%">
    <a-layout-header class="headerStyle">
      <div class="left-groups">
        <a-segmented v-model:value="trQueryConditionStore.timeRangeTypeLabel" :options="TimeRangeTypeLabels"/>
        <a-button type="text" @click="goToPrevious">
          <template #icon>
            <LeftOutlined style="display: flex;justify-content: center;align-items: center;font-size: large"/>
          </template>
        </a-button>
        <a-range-picker
            v-model:value="trQueryConditionStore.timeRange"
            :picker="trQueryConditionStore.timeRangeTypeValue"
            :presets="TimeRangePresets"
            inputReadOnly
        />
        <a-button type="text" @click="goToNext">
          <template #icon>
            <RightOutlined style="display: flex;justify-content: center;align-items: center;font-size: large"/>
          </template>
        </a-button>
      </div>
      <div class="center-groups">
      </div>
      <div class="right-groups">
        <a-button type="primary" @click="createTr">
          新增记录
        </a-button>
      </div>
    </a-layout-header>
    <a-layout-content :style="contentStyle">
      <transaction-record-table :items="tableData" @update-item="updateTr"/>
    </a-layout-content>
    <a-layout-footer class="footerStyle">
      <a-pagination
          v-model:current="currentPage"
          v-model:pageSize="pageSize"
          :total="trTotal"
          :show-total="total => `共${total}记录`"
          show-size-changer
      />
    </a-layout-footer>
    <a-drawer
        :title="drawerTitle"
        :open="openTrDrawer"
        :body-style="{ paddingBottom: '80px' }"
        :footer-style="{ textAlign: 'right' }"
        @close="closeTrDrawer"
        :closable="false"
    >
      <a-form :model="trForm">
        <a-form-item label="时间" name="time">
          <a-date-picker v-model:value="trForm.time" style="width: 100%"/>
        </a-form-item>

        <a-form-item label="类型" name="type">
          <a-radio-group v-model:value="trForm.type" button-style="solid">
            <a-radio-button value="income">收入</a-radio-button>
            <a-radio-button value="expense">支出</a-radio-button>
            <a-radio-button value="transfer">转账</a-radio-button>
          </a-radio-group>
        </a-form-item>

        <a-form-item label="分类" name="category">
          <a-select v-model:value="trForm.category" :options="categories"/>
        </a-form-item>

        <a-form-item label="标签" name="tags">
          <a-select v-model:value="trForm.tags" :options="tags" mode="multiple" placeholder="选择一个或多个标签"/>
        </a-form-item>

        <a-form-item label="描述" name="description">
          <a-input v-model:value="trForm.description" placeholder="描述消费内容" allowClear/>
        </a-form-item>

        <a-form-item label="金额" name="price">
          <a-input-number v-model:value="trForm.price" prefix="￥" :controls="false" :min="0" style="width: 100%"/>
        </a-form-item>
      </a-form>
      <template #extra>
        <a-space>
          <a-button @click="closeTrDrawer">取消</a-button>
          <a-button type="primary" @click="onConfirm">确认</a-button>
        </a-space>
      </template>
    </a-drawer>
  </a-layout>
</template>

<script setup lang="ts">
import {computed, type CSSProperties, ref, watch} from 'vue';
import TransactionRecordTable from '@/components/tr_view/TransactionRecordTable.vue';
import {TimeRangePresets, TimeRangeTypeLabels} from "@/backend/constant.ts";
import type {TransactionRecord, TrForm, TrQueryCondition} from "@/types/billadm";
import {useCssVariables} from "@/backend/css.ts";
import {LeftOutlined, RightOutlined} from "@ant-design/icons-vue";
import {convertToUnixTimeRange, getNextPeriod, getPrevPeriod} from "@/backend/timerange.ts";
import {
  createTransactionRecord,
  getTrOnCondition,
  getTrTotalOnCondition,
  updateTransactionRecord
} from "@/backend/functions.ts";
import {useLedgerStore} from "@/stores/ledgerStore.ts";
import {useTrQueryConditionStore} from "@/stores/trQueryConditionStore.ts";
import dayjs from "dayjs";
import {useCategoryStore} from "@/stores/categoryStore.ts";
import {useTagStore} from "@/stores/tagStore.ts";
import {trDtoToTrForm, trFormToTrDto} from "@/backend/dto-utils.ts";

const {majorBgColor} = useCssVariables();

const contentStyle: CSSProperties = {
  backgroundColor: majorBgColor.value,
  "overflow-y": "auto",
  "margin-bottom": "auto"
};

const ledgerStore = useLedgerStore();
const trQueryConditionStore = useTrQueryConditionStore();
const categoryStore = useCategoryStore();
const tagStore = useTagStore();

const goToPrevious = () => {
  trQueryConditionStore.timeRange = getPrevPeriod(trQueryConditionStore.timeRange[0],
      trQueryConditionStore.timeRange[1],
      trQueryConditionStore.timeRangeTypeValue);
}

const goToNext = () => {
  trQueryConditionStore.timeRange = getNextPeriod(trQueryConditionStore.timeRange[0],
      trQueryConditionStore.timeRange[1],
      trQueryConditionStore.timeRangeTypeValue);
}

// 消费记录
const tableData = ref<TransactionRecord[]>([]);
// 分页
const currentPage = ref<number>(1);
const pageSize = ref<number>(20);
const trTotal = ref<number>(0);

const refreshTable = async () => {
  const trTotalCondition: TrQueryCondition = {
    ledgerId: ledgerStore.currentLedgerId,
    tsRange: convertToUnixTimeRange(trQueryConditionStore.timeRange)
  }
  trTotal.value = await getTrTotalOnCondition(trTotalCondition);
  const trCondition: TrQueryCondition = {
    ledgerId: ledgerStore.currentLedgerId,
    tsRange: convertToUnixTimeRange(trQueryConditionStore.timeRange),
    offset: pageSize.value * (currentPage.value - 1),
    limit: pageSize.value
  }
  tableData.value = await getTrOnCondition(trCondition);
}

const openTrDrawer = ref(false);
const drawerTitle = ref('');
const trForm = ref<TrForm>({} as TrForm);

const categories = computed(() => {
  return categoryStore.getCategoryNamesByType(trForm.value.type);
})

const tags = computed(() => {
  return tagStore.getTagNamesByCategory(trForm.value.category);
})

const createTr = () => {
  resetTrForm();
  drawerTitle.value = '新增消费记录';
  openTrDrawer.value = true;
}

const updateTr = (tr: TransactionRecord) => {
  drawerTitle.value = '编辑消费记录';
  trForm.value = trDtoToTrForm(tr);
  openTrDrawer.value = true;
}

const closeTrDrawer = () => {
  openTrDrawer.value = false;
}

const resetTrForm = () => {
  trForm.value = {
    id: '',
    price: 0,
    type: 'expense',
    category: '',
    description: '',
    tags: [],
    time: dayjs()
  }
}

const onConfirm = () => {
  const tr = trFormToTrDto(trForm.value, ledgerStore.currentLedgerId);
  if (tr.transactionId === '') {
    // 新建
    createTransactionRecord(tr);
  } else {
    // 更新
    updateTransactionRecord(tr);
  }
  refreshTable();
  closeTrDrawer();
}

watch(() => [
      trQueryConditionStore.timeRange,
      ledgerStore.currentLedgerId,
      currentPage.value,
      pageSize.value
    ],
    () => {
      refreshTable();
    }, {immediate: true});
</script>

<style scoped>
.headerStyle {
  height: auto;
  background-color: var(--billadm-color-major-background);
  padding: 0 0 16px 0;
  display: flex;
  align-items: start;
  justify-content: center;
}

.footerStyle {
  height: auto;
  background-color: var(--billadm-color-major-background);
  padding: 16px 0 0 0;
  display: flex;
  align-items: end;
  justify-content: center;
}

/* 左边按钮 将它与后面的元素隔开 */
.left-groups {
  margin-right: auto;
  display: flex;
  gap: 8px;
  align-items: center;
}

/* 中间按钮 */
.center-groups {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  gap: 8px;
}

/* 右边按钮组 */
.right-groups {
  display: flex;
  gap: 8px;
}
</style>